<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LibraryReach Control Console</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#sidebar">Skip to controls</a>
    <div id="layout">
      <aside id="sidebar">
        <div class="header">
          <div class="header-top">
            <div>
              <div class="title">LibraryReach</div>
              <div class="subtitle">Control Console (baseline + what-if)</div>
            </div>
            <div class="header-actions">
              <a class="btn subtle" href="/" title="Back to homepage">Home</a>
              <button id="densityToggle" class="btn subtle" type="button" aria-pressed="false" title="Toggle density">
                Comfort
              </button>
              <button id="themeToggle" class="btn subtle" type="button" aria-pressed="false" title="Toggle theme">
                Light
              </button>
            </div>
          </div>
          <div id="status" class="status">Loading…</div>
          <div id="dataStatus" class="data-status muted">Data status: loading…</div>
          <div class="row" style="margin-top: 8px">
            <button id="refreshStatus" class="btn subtle" type="button">Refresh</button>
            <button id="copyFixCmd" class="btn subtle" type="button">Copy fix commands</button>
          </div>
          <div id="story" class="story muted">Tip: run Apply to generate a what-if summary.</div>
          <div id="notice" class="notice hidden" role="status" aria-live="polite">
            <div id="noticeText" class="notice-text"></div>
            <button id="noticeClose" class="notice-close" type="button" aria-label="Close notice">×</button>
          </div>
        </div>

        <div class="foldout" data-foldout="controls">
          <button class="foldout-header" type="button">Controls</button>
          <div class="foldout-body">
            <div class="row">
              <label class="field">
                <span>Scenario</span>
                <select id="scenario"></select>
              </label>
              <button id="apply" class="btn primary" type="button" title="Ctrl+Enter">Apply</button>
              <button id="reset" class="btn" type="button">Reset</button>
            </div>
            <div class="row">
              <button id="validate" class="btn" type="button">Validate Catalogs</button>
              <button id="help" class="btn" type="button" title="?">Shortcuts</button>
              <button id="copyLink" class="btn subtle" type="button">Copy Link</button>
            </div>

            <div class="subheader">Cities</div>
            <div id="cities" class="checkbox-grid"></div>

            <div class="subheader">Layers</div>
            <div class="checkbox-grid">
              <label class="check"><input id="layerLibraries" type="checkbox" checked />Libraries (L)</label>
              <label class="check"><input id="layerDeserts" type="checkbox" checked />Deserts (D)</label>
              <label class="check"><input id="layerOutreach" type="checkbox" checked />Outreach (O)</label>
              <label class="check"><input id="layerMetro" type="checkbox" />Metro stations (M)</label>
              <label class="check"><input id="layerYoubike" type="checkbox" />YouBike stations (Y)</label>
            </div>
            <div class="hint">
              Tip: use layers to read the story. Metro/YouBike layers depend on ingestion outputs (TDX).
            </div>
          </div>
        </div>

        <div class="foldout" data-foldout="highlights">
          <button class="foldout-header" type="button">Highlights</button>
          <div class="foldout-body">
            <div class="row">
              <label class="field" style="flex: 1">
                <span>Show Top N</span>
                <select id="highlightKind">
                  <option value="low_library_score">Lowest library access score</option>
                  <option value="high_desert_gap">Largest desert gap</option>
                  <option value="top_outreach">Top outreach recommendations</option>
                </select>
              </label>
              <label class="field" style="width: 110px">
                <span>N</span>
                <input id="highlightTopN" type="number" min="1" step="1" value="20" />
              </label>
            </div>
            <div class="row">
              <button id="highlightApply" class="btn primary" type="button">Show</button>
              <button id="highlightClear" class="btn" type="button">Clear</button>
            </div>
            <div class="row">
              <label class="field" style="flex: 1">
                <span>Spotlight mode</span>
                <select id="spotlightMode">
                  <option value="all" selected>All layers</option>
                  <option value="highlights">Highlights only</option>
                  <option value="selection">Selection only</option>
                </select>
              </label>
            </div>
            <div class="hint">This highlights the most relevant points for quick briefings and projection.</div>
          </div>
        </div>

        <div class="foldout" data-foldout="scoring">
          <button class="foldout-header" type="button">Scoring</button>
          <div class="foldout-body">
            <div class="subheader">Mode Weights</div>
            <div class="row">
              <label class="field">
                <span>Bus</span>
                <input id="wBus" type="number" min="0" max="1" step="0.05" />
              </label>
              <label class="field">
                <span>Metro</span>
                <input id="wMetro" type="number" min="0" max="1" step="0.05" />
              </label>
            </div>

            <div class="subheader">Radius Weights</div>
            <div class="row">
              <label class="field">
                <span>500m</span>
                <input id="w500" type="number" min="0" max="1" step="0.05" />
              </label>
              <label class="field">
                <span>1000m</span>
                <input id="w1000" type="number" min="0" max="1" step="0.05" />
              </label>
            </div>

            <div class="subheader">Density Targets (per km²)</div>
            <div class="grid2">
              <label class="field">
                <span>Bus @500</span>
                <input id="tBus500" type="number" min="0" step="1" />
              </label>
              <label class="field">
                <span>Bus @1000</span>
                <input id="tBus1000" type="number" min="0" step="1" />
              </label>
              <label class="field">
                <span>Metro @500</span>
                <input id="tMetro500" type="number" min="0" step="0.5" />
              </label>
              <label class="field">
                <span>Metro @1000</span>
                <input id="tMetro1000" type="number" min="0" step="0.5" />
              </label>
            </div>
            <div class="hint">Tip: keep weights normalized; the UI auto-fixes minor drift.</div>
          </div>
        </div>

        <div class="foldout" data-foldout="planning">
          <button class="foldout-header" type="button">Planning</button>
          <div class="foldout-body">
            <div class="subheader">Deserts</div>
            <div class="row">
              <label class="field">
                <span>Threshold (0–100)</span>
                <input id="desertThreshold" type="number" min="0" max="100" step="1" />
              </label>
              <label class="field">
                <span>Grid (m)</span>
                <input id="gridSize" type="number" min="250" step="250" />
              </label>
            </div>
            <div class="row">
              <label class="field">
                <span>Search Radius (m)</span>
                <input id="desertSearchRadius" type="number" min="500" step="250" />
              </label>
            </div>

            <div class="subheader">Outreach</div>
            <div class="row">
              <label class="field">
                <span>Coverage Radius (m)</span>
                <input id="outreachRadius" type="number" min="250" step="250" />
              </label>
              <label class="field">
                <span>Top N / City</span>
                <input id="outreachTopN" type="number" min="1" step="1" />
              </label>
            </div>
            <div class="row">
              <label class="field">
                <span>Coverage Weight</span>
                <input id="wCoverage" type="number" min="0" max="1" step="0.05" />
              </label>
              <label class="field">
                <span>Site Access Weight</span>
                <input id="wSite" type="number" min="0" max="1" step="0.05" />
              </label>
            </div>

            <div class="subheader">Candidate Types</div>
            <div id="candidateTypes" class="checkbox-grid"></div>
          </div>
        </div>

        <div class="foldout" data-foldout="inspector">
          <button class="foldout-header" type="button">Inspector</button>
          <div class="foldout-body">
            <div class="subheader">Find a library</div>
            <div class="row">
              <label class="field" style="flex: 1; min-width: 220px">
                <span>Search</span>
                <input id="librarySearch" type="search" placeholder="Name / address / city / district" />
              </label>
              <button id="librarySearchClear" class="btn subtle" type="button">Clear</button>
            </div>
            <div id="librarySearchResults" class="list" aria-label="Search results"></div>
            <div class="hint">Tip: click a result to locate it on the map and open details.</div>

            <div class="subheader">Selected</div>
            <div id="inspector" class="muted">Click a library marker.</div>
          </div>
        </div>

        <div class="foldout" data-foldout="sources">
          <button class="foldout-header" type="button">Data & Provenance</button>
          <div class="foldout-body">
            <div id="sourcesCardConsole" class="sources-card-slot"></div>
          </div>
        </div>

        <div class="foldout" data-foldout="outreach">
          <button class="foldout-header" type="button">Outreach List</button>
          <div class="foldout-body">
            <div id="outreachList" class="muted">Loading…</div>
          </div>
        </div>
      </aside>
      <main id="mapWrap">
        <div id="map"></div>
        <div id="actionDrawer" class="action-drawer" role="status" aria-live="polite" aria-relevant="additions"></div>
        <div id="legend" class="legend" aria-label="Map legend">
          <div class="legend-title">Legend</div>
          <div class="legend-row">
            <span class="legend-dot low" aria-hidden="true"></span>
            <span>Library access score 0–40</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot mid" aria-hidden="true"></span>
            <span>Library access score 40–70</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot high" aria-hidden="true"></span>
            <span>Library access score 70–100</span>
          </div>
          <div class="legend-divider"></div>
          <div class="legend-row">
            <span class="legend-dot desert" aria-hidden="true"></span>
            <span>Access desert cell</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot outreach" aria-hidden="true"></span>
            <span>Outreach recommendation</span>
          </div>
          <div class="legend-divider"></div>
          <div class="legend-row">
            <span class="legend-dot metro" aria-hidden="true"></span>
            <span>Metro station (label = name)</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot youbike" aria-hidden="true"></span>
            <span>YouBike station (location only)</span>
          </div>
          <div class="legend-divider"></div>
          <div id="legendUpdatedAt" class="legend-foot muted">Updated: —</div>
        </div>
      </main>
    </div>

    <div id="overlay" class="overlay hidden" role="dialog" aria-modal="true">
      <div class="overlay-card">
        <div class="overlay-title">Keyboard Shortcuts</div>
        <div class="overlay-body">
          <div class="shortcut-grid">
            <div class="k">W/A/S/D</div>
            <div class="v">Pan</div>
            <div class="k">Q/E</div>
            <div class="v">Rotate</div>
            <div class="k">R/F</div>
            <div class="v">Zoom in/out</div>
            <div class="k">Z/X</div>
            <div class="v">Pitch up/down</div>
            <div class="k">0</div>
            <div class="v">Reset bearing/pitch</div>
            <div class="k">L/D/O/M/Y</div>
            <div class="v">Toggle layers</div>
            <div class="k">Ctrl+Enter</div>
            <div class="v">Apply parameters</div>
            <div class="k">Ctrl+S</div>
            <div class="v">Save preset (local)</div>
            <div class="k">?</div>
            <div class="v">Toggle this panel</div>
            <div class="k">Esc</div>
            <div class="v">Close panel</div>
          </div>
          <div class="hint">Tip: hold Shift to speed up camera, hold Alt to slow down.</div>
        </div>
        <div class="overlay-footer">
          <button id="closeOverlay" class="btn primary" type="button">Close</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="/static/dataClient.js"></script>
    <script src="/static/sourcesCard.js"></script>
    <script src="/static/density.js"></script>
    <script src="/static/app.js"></script>
  </body>
</html>
